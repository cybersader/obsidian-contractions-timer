#!/bin/bash
# Pre-commit hook: prevent personal data from being committed
# Install with: scripts/setup-hooks.sh

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

FOUND_ISSUES=0

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Patterns that indicate personal data or local paths
# Note: 'password' removed â€” too many false positives in P2P sharing code
# that legitimately references password as a feature parameter
PERSONAL_PATTERNS=(
    'C:\\Users\\'
    'C:/Users/'
    '/Users/'
    '/home/'
    '/mnt/c/Users/'
    '@gmail.com'
    '@yahoo.com'
    '@hotmail.com'
    '@outlook.com'
    'api_key'
    'API_KEY'
    'secret_key'
    'SECRET_KEY'
)

# Check each staged file for personal data patterns
for file in $STAGED_FILES; do
    # Skip binary files, this hook, and the check script (which defines the patterns)
    if [[ "$file" == *.png ]] || [[ "$file" == *.jpg ]] || [[ "$file" == *.gif ]] || [[ "$file" == ".githooks/pre-commit" ]] || [[ "$file" == "scripts/check-personal-data.sh" ]]; then
        continue
    fi

    # Skip files that don't exist (renamed/moved)
    if [ ! -f "$file" ]; then
        continue
    fi

    for pattern in "${PERSONAL_PATTERNS[@]}"; do
        if grep -q "$pattern" "$file" 2>/dev/null; then
            echo -e "${RED}BLOCKED:${NC} Found personal data pattern '${pattern}' in ${file}"
            FOUND_ISSUES=1
        fi
    done
done

# Check for .claude/settings.local.json
if echo "$STAGED_FILES" | grep -q "settings.local.json"; then
    echo -e "${RED}BLOCKED:${NC} Attempting to commit settings.local.json (should be gitignored)"
    FOUND_ISSUES=1
fi

if [ $FOUND_ISSUES -eq 1 ]; then
    echo ""
    echo -e "${RED}Commit blocked: personal data detected in staged files.${NC}"
    echo "Review the files above and remove personal information before committing."
    echo "If this is a false positive, use: git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}Pre-commit check passed: no personal data found.${NC}"
exit 0
